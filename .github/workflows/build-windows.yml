name: Build on Windows

on:
  push:
    branches:
      - WIP-cmake
  pull_request:
    branches:
      - '*'

jobs:
  build:
    runs-on: windows-2019
    env:
      CONAN_REVISIONS_ENABLED: 1

    steps:
    #- name: install aptinstall
    #  run: pip install aqtinstall

    #- name: What versions of qt are avaliable
    #  run: aqt list-qt windows desktop

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: 'recursive'

    #- name: Fetch tags for survex
    #  run: |
    #    cd survex
    #    git fetch --tags
    #    git fetch --all

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      with:
        msbuild-architecture: x64

    - name: Cache Conan packages
      uses: actions/cache@v2
      with:
        path: .conan
        key: ${{ runner.os }}-conan-${{ hashFiles('**/conanfile.py') }}
        restore-keys: |
          ${{ runner.os }}-conan-

    - name: Install Conan
      run: pip install conan==1.60.2

    - name: Conan Profile
      run: conan profile new default --detect

    - name: Add Conan Remotes
      run: |
        conan remote add bincrafters https://bincrafters.jfrog.io/artifactory/api/conan/public-conan

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        dir: '${{ github.workspace }}/'
        install-deps: 'true'
        #modules: 'qtpdf'
        #archives: 'qtbase qtsvg'
        cache: 'true'
        cache-key-prefix: 'install-qt-action'

    - name: Install perl Locale::PO
      run: cpan install Locale::PO

    - name: Conan Install Dependencies
      run: conan install . --build missing

    - name: Create Build Directory
      run: mkdir build

    - name: Install ninja-build tool
      uses: seanmiddleditch/gha-setup-ninja@v3

    - name: CMake Configure
      run: cmake -G Ninja -S D:/a/cavewhere/cavewhere/ -DCMAKE_BUILD_TYPE=Release -DWITH_PDF=OFF -DCMAKE_PREFIX_PATH="D:/a/cavewhere/cavewhere/Qt/5.15.2/msvc2019_64" -DCMAKE_MODULE_PATH="D:/a/cavewhere/cavewhere" -B build

    - name: CMake Build
      run: cmake --build build --target all

    - name: CMake Build Windows Installer
      run: cmake --build build --target windowsInstaller

    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: windows-artifact
        path: build/Cavewhere*64bit.exe


#name: Build on Windows
#
#on:
#  push:
#    branches:
#      - WIP-cmake
#  pull_request:
#    branches:
#      - '*'
#
#jobs:
#  build:
#    runs-on: windows-2019
#
#    steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#      with:
#        submodules: 'recursive'
#
#    - name: Setup MSBuild
#      uses: microsoft/setup-msbuild@v1.1
#      with:
#        msbuild-architecture: x64
#
#    - name: Install Conan
#      run: pip install conan==1.60.2
#
#    - name: Conan Profile
#      run: conan profile new default --detect
#
#    - name: Add Conan Remotes
#      run: |
#      conan remote add bincrafters https://bincrafters.jfrog.io/artifactory/api/conan/public-conan
#
#    - name: Conan Install Dependencies
#      run: conan install . --build missing -o CaveWhere/*:system_qt=False
#
#    - name: Create Build Directory
#      run: mkdir build
#
#    - name: CMake Configure
#      run: cmake -S . -B build
#
#    - name: CMake Build
#      run: cmake --build build --target all
#
#    - name: CMake Build Windows Installer
#      run: cmake --build build --target windowsInstaller
#
#    - name: Upload Artifact
#      uses: actions/upload-artifact@v3
#      with:
#        name: windows-artifact
#        path: build/Cavewhere*64bit.exe
